<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-jsonp-library/iron-jsonp-library.html">
<link rel="import" href="bower_components/carbon-route/carbon-route.html">
<link rel="import" href="bower_components/carbon-route/carbon-location.html">

<dom-module id="map-element">
    <style>
    :host {
        height:auto;
        width:100%;
    }
    #map {
        height: 100%;
        width: 100%;
    }
    </style>
    <template>
        <iron-jsonp-library library-url="https://maps.googleapis.com/maps/api/js?callback=%%callback%%" notify-event="api-load" library-loaded="{{loaded}}"></iron-jsonp-library>
        <div id="map"></div>
    </template>
</dom-module>

<dom-module id="static-map">
    <template>
    <img src="https://maps.googleapis.com/maps/api/staticmap?zoom={{zoom}}&size={{size}}&maptype={{maptype}}&center={{center}}">
    </template>
</dom-module>

<dom-module id="map-controller">
    <style>
        #dynamicmap{
            height: 400px;
            width: 400px;
            position: absolute;
            top: 97px;
            left: 401px;
            z-index: 100;
            border: 2px solid black;
            pointer-events: none;
        }
    </style>
    <template>
        <carbon-location route="{{route}}" use-hash-as-path></carbon-location>
        <carbon-route
            route="{{route}}"
            pattern="/buttontext/:buttonText"
            data="{{data}}"
            tail="{{tail}}">
        </carbon-route>

        <div id="dynamicmap"></div>
        <map-element maplocation='{{mapcenter}}' mapzoom="{{mapzoom}}"></map-element>
        <static-map center="{{staticcenter}}" size="400x400" zoom="{{staticzoom}}" maptype="roadmap"></static-map>
        <button on-tap="syncroMaps">{{data.buttonText}}</button>
    </template>
</dom-module>

<script>
Polymer({
    is: "map-element",
    properties: {
        maplocation: {
            type: Object,
            notify: true
        },
        mapzoom: {
            type: Number,
            notify: true,
            value: 13
        }
    },
    listeners: {
        'api-load': 'initMap',
    },
    ready: function() {
    },
    initMap: function() {
        var options = {
            zoom: this.mapzoom,
            center: new google.maps.LatLng(this.maplocation)
        };
        var map = new google.maps.Map(
            document.getElementById('map'),
            options);
        map.addListener('center_changed', function(this_){
            return function(){
            this_.maplocation = map.getCenter().toJSON();
        }}(this));
        map.addListener('zoom_changed', function(this_){
            return function(){
            this_.mapzoom = map.getZoom();
        }}(this));
    }
});

Polymer({
    is: "static-map",
    properties:{
        center:{
            type: String,
            notify: true
        },
        zoom:{
            type: Number,
            notify: true
        }
    }
});

Polymer({
    is: "map-controller",
    properties:{
        mapcenter: {
            type: Object,
            value: {"lat":0,"lng":0}
        },
        mapzoom: {
            type: Number,
            value: 13
        }
    },
    syncroMaps: function(e){
        this.staticcenter = this.mapcenter.lat+","+this.mapcenter.lng;
        this.staticzoom = this.mapzoom;
    },
    ready: function(){
        this.staticcenter = this.mapcenter.lat+","+this.mapcenter.lng;
        this.staticzoom = this.mapzoom;
        console.log("route: ", this.route);
    },
    attached: function(){
        var mapelement = this.querySelector("map-element");
        var rect = this.querySelector("#dynamicmap");
        rect.style.top = (mapelement.offsetHeight - 400)/2 + "px";
        rect.style.left = (mapelement.offsetWidth - 400)/2 + "px";
    }
});
</script>